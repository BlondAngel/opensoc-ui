<div ng-controller='pcap'>

  <style>
    span, td, th {
      font-size: 13px;
    }

    .table-container {
      display: table;
      height: 100px;
      width: 100%;
      table-layout: fixed;
    }
    .table-details {
      table-layout: fixed;
    }

    .pcap-es-results {
      height: 200px;
      overflow-y: auto;
    }

    .pcap-raw {
      background: #FCFCFC;
      color: #5F5F5F;
    }

    .packet-list {
      max-height: 300px;
      overflow-y: scroll;
    }

    .packet .stack {
      max-height: 200px;
      overflow-y: scroll;
      border-radius: 1px;
      border: 1px solid #333;
      border-collapse: separate;
      border-left: 0;
      margin: 20px 0;
      padding-bottom: 10px;
    }

    .highlight {
      background-color: #0067B5;
    }

    .newline:after {
      content:"\A";
      white-space:pre;
    }

    .padright {
      margin-left: 16px !important;
    }

    .pcap-editor {
      background-color: #333;
      padding: 5px;
      margin-bottom: 5px;
    };

  </style>

  <p ng-if="!user.permissions.pcap">Access Denied</p>

  <div class="table-container" ng-if="user.permissions.pcap">
    <div class="pcap-editor">
      <div class="editor-row">
        <div class="editor-option">
          <label class="small">Source IP</label><input type="text"
              class="input-medium" ng-model="$parent.ip_src_addr"></input>
        </div>
        <div class="editor-option">
          <label class="small">Destination IP</label><input type="text"
              class="input-medium" ng-model="$parent.ip_dst_addr"></input>
        </div>
        <div class="editor-option">
          <label class="small">Source Port</label><input type="text"
              class="input-medium" ng-model="$parent.ip_src_port"></input>
        </div>
        <div class="editor-option">
          <label class="small">Destination Port</label><input type="text"
              class="input-medium" ng-model="$parent.ip_dst_port"></input>
        </div>
        <div class="editor-option">
          <label class="small">Protocol</label><input type="text"
              class="input-small" ng-model="$parent.ip_protocol"></input>
        </div>
      </div>

      <div class="editor-row">
        <div class="editor-option">
          <label class="small">Timestamp</label>
          <span timestamp-input ts="$parent.ts_usec"></span>
        </div>
        <div class="editor-option">
          <label class="small">Duration(+/-)</label>
          <select class="input-small"
              ng-options="d.desc for d in durations"
              ng-model="$parent.duration"></select>
        </div>
        <div class="editor-option">
          <label class="small">&nbsp</label><button type="button"
              class="btn btn-success" ng-click="search()">Search</button>

          <label class="small">Reverse Traffic
            <input type="checkbox" class="input-small"
                ng-model="$parent.includeReverseTraffic"></input></label>
        </div>
      </div>
    </div>

    <div class="pcap-es-results" ng-if="results">
      <h6>PCAP Search Results</h6>

      <table class="table table-bordered table-condensed table-details table-striped"
          ng-style="panel.style">
        <thead>
          <tr>
            <td class="span1">Packets</td>
            <td class="span2">Source IP</td>
            <td class="span2">Destination IP</td>
            <td class="span1">Source Port</td>
            <td class="span1">Destination Port</td>
            <td class="span1">Protocol</td>
            <td class="span4">Pcap ID</td>
          <tr>
        </thead>

        <tbody bindonce ng-repeat="doc in results.facets.packets.terms">
          <tr ng-click="setPcapId($index, doc.term)"
              ng-class="{highlight : $index === selected}"
              ng-init="doc.unhexed = parsePcapId(doc.term)">
            <td>{{ doc.count }}</td>
            <td>{{ doc.unhexed.src_ip }}</td>
            <td>{{ doc.unhexed.dst_ip }}</td>
            <td>{{ doc.unhexed.src_port }}</td>
            <td>{{ doc.unhexed.dst_port }}</td>
            <td>{{ doc.unhexed.protocol }}</td>
            <td>{{ doc.term }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pcap-es-results">
      <table class="table table-bordered table-condensed table-details table-striped"
          ng-style="panel.style" ng-show="packetData.length">
        <thead>
          <tr>
            <td class="span1">No.</td>
            <td class="span2">Source</td>
            <td class="span2">Destination</td>
            <td class="span7">Info</td>
          <tr>
        </thead>
        <tbody ng-repeat="packet in packetData">
            <tr ng-click="$parent.drilldown = packet"
                ng-class="{highlight : $parent.drilldown == packet}">
              <td><span>{{$index + 1}}</span></td>
              <td>{{packet.proto[3].field[10].$.show}}</td>
              <td>{{packet.proto[3].field[14].$.show}}</td>
              <td>{{packet.proto[4].field[0].$.showname | sourcePort}}</td>
            </tr>
        </tbody>
      </table>
    </div>

    <div ng-if="drilldown">
      <div packet="drilldown" class="packet"></div>
    </div>
  </div>
</div>

<script type="text/ng-template" id="packet.html">
  <div class="stack" proto="packet.proto" selected="selected"></div>
  <div hex-bytes dump="packet.hexdump" selected="selected"></div>
</script>

<script type="text/ng-template" id="proto.html">
  <div ng-repeat="f in proto">
    <div ng-click="select(f)"
        ng-class="{highlight: $parent.selected.uid == f.$.uid}">

      <div style="padding-left: {{ $parent.padding }}px">
        <span ng-if="!f.field" class="icon-asterisk"></span>
        <span ng-if="f.field" ng-class="{
            'icon-chevron-down': f.$.expanded,
            'icon-chevron-right': !f.$.expanded
          }"></span>

        {{ f.$.showname || f.$.show}}
      </div>
    </div>

    <div class="fields" ng-if="f.field.length && f.$.expanded">
      <div proto="f.field" padding="nextPadding" selected="selected"></div>
    </div>
  </div>
</script>

<script type="text/ng-template" id="hexBytes.html">
  <div class="row">
    <div class="span6">
      <span ng-repeat="b in bytes track by $index">
        <span class="byte" ng-class="{
          highlight: selected.pos <= $index &&
            (selected.pos|num)+(selected.size|num) > $index,
          newline: $index % 16 == 15,
          padright: $index % 16 == 8}"
          ng-click="selectByte($index)"
          style="font-family: monospace;">{{ b }} </span>
      </span>
    </div>

    <div class="span6">
      <span ng-repeat="b in bytes track by $index">
        <span class="byte" ng-class="{
          highlight: (selected.pos|num) <= $index &&
              (selected.pos|num) + (selected.size|num) > $index,
          newline: $index % 16 == 15,
          padright: ($index + 8) % 16 == 0}"
          ng-click="selectByte($index)"
          style="font-family: monospace;">{{ b | toAscii }}</span>
      </span>
    </div>
  </div>
</script>

<script type="text/ng-template" id="timestampInput.html">
  <input ng-repeat="t in tsTypes" ng-show="tsType == t"
      class="input-medium" type="text" ng-model="$parent.tsInput"/>
  <select class="input-small" ng-options="t for t in tsTypes"
      ng-model="tsType"></select>
</script>
